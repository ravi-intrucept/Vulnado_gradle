trigger:
  - master

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/project.zip' 
    replaceExistingArchive: true
  displayName: 'Create project zip'

- script: |
    SAST_RESPONSE=$(curl -X POST \
      -H "Client-ID: $(INTRUCEPT_CLIENT_ID)" \
      -H "Client-Secret: $(INTRUCEPT_CLIENT_SECRET)" \
      -F "projectZipFile=@$(Build.ArtifactStagingDirectory)/project.zip" \
      -F "applicationId=$(INTRUCEPT_APPLICATION_ID)" \
      -F "scanName=SAST Scan from Azure Pipeline" \
      -F "language=javascript" \
      https://appsecops-api.intruceptlabs.com/api/v1/integrations/sast-scans)
    
    echo "SAST Response:"
    SAST_VULNS_TABLE=$(echo "$SAST_RESPONSE" | jq -r '.vulnsTable')
    if [ "$SAST_VULNS_TABLE" != "null" ] && [ -n "$SAST_VULNS_TABLE" ]; then
      echo "$SAST_VULNS_TABLE"
    else
      echo "No SAST vulnerabilities found"
    fi
    
    SAST_CAN_PROCEED=$(echo $SAST_RESPONSE | jq -r '.canProceed')
    echo "##vso[task.setvariable variable=sastCanProceed;isOutput=true]$SAST_CAN_PROCEED"
  displayName: 'Perform SAST Scan'
  name: sastScan

- script: |
    SCA_RESPONSE=$(curl -X POST \
      -H "Client-ID: $(INTRUCEPT_CLIENT_ID)" \
      -H "Client-Secret: $(INTRUCEPT_CLIENT_SECRET)" \
      -F "projectZipFile=@$(Build.ArtifactStagingDirectory)/project.zip" \
      -F "applicationId=$(INTRUCEPT_APPLICATION_ID)" \
      -F "scanName=SCA Scan from Azure Pipeline" \
      -F "language=javascript" \
      https://appsecops-api.intruceptlabs.com/api/v1/integrations/sca-scans)
    
    echo "SCA Response:"
    SCA_VULNS_TABLE=$(echo "$SCA_RESPONSE" | jq -r '.vulnsTable')
    if [ "$SCA_VULNS_TABLE" != "null" ] && [ -n "$SCA_VULNS_TABLE" ]; then
      echo "$SCA_VULNS_TABLE"
    else
      echo "No SCA vulnerabilities found"
    fi
    
    SCA_CAN_PROCEED=$(echo $SCA_RESPONSE | jq -r '.canProceed')
    echo "##vso[task.setvariable variable=scaCanProceed;isOutput=true]$SCA_CAN_PROCEED"
  displayName: 'Perform SCA Scan'
  name: scaScan

- script: |
    echo "SAST or SCA scan failed. Deployment cancelled."
    exit 1
  condition: and(succeeded(), or(ne(variables['sastScan.sastCanProceed'], 'true'), ne(variables['scaScan.scaCanProceed'], 'true')))
  displayName: 'Check SAST and SCA results'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)/project.zip'
    artifactName: 'drop'
  displayName: 'Publish Artifact'
  condition: and(succeeded(), eq(variables['sastScan.sastCanProceed'], 'true'), eq(variables['scaScan.scaCanProceed'], 'true'))

- task: DownloadBuildArtifacts@0
  inputs:
    buildType: 'current'
    downloadType: 'single'
    artifactName: 'drop'
    downloadPath: '$(System.ArtifactsDirectory)'

- task: ExtractFiles@1
  inputs:
    archiveFilePatterns: '$(System.ArtifactsDirectory)/drop/project.zip'
    destinationFolder: '$(System.DefaultWorkingDirectory)/extracted'
    cleanDestinationFolder: true

- task: NodeTool@0
  inputs:
    versionSpec: '18'
  displayName: 'Install Node.js'

- script: |
    cd $(System.DefaultWorkingDirectory)/extracted
    npm ci
    npm run build
  displayName: 'npm install and build'

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      git config --global user.email "azurepipeline@example.com"
      git config --global user.name "Azure Pipeline"
      
      cd $(System.DefaultWorkingDirectory)/extracted
      
      git init
      git add .
      git commit -m "Deploy from Azure Pipelines"
      
      git remote add origin https://x-access-token:$(GITHUB_TOKEN)@github.com/ravi-intrucept/Vulnado_gradle.git
      git push -f origin HEAD:main
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)
  displayName: 'Push to GitHub'